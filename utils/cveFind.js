const axios = require('axios');
const cheerio = require('cheerio');
const BASE_URL = "https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword="


const cleanString = (str) => {
    return str.replace(/\\n/g, ' ').replace(/\\t/g, ' ').replace(/\\/g, '').substring(0, str.indexOf("Search CVE") != -1 ? str.indexOf("Search CVE") - 9 : (str.length - 1)).trim()
}

const fetchCVE = async(softwares) => {

    let results = []
    for (let software of softwares) {
        let { target, softwareName, softwareVersion } = software

        let tokens = softwareName.split(" ")
        let query = tokens.join("+")
        let text = await axios.get(BASE_URL + query)
        let CVEs = { count: 0, data: [] }
        let html = JSON.stringify(text.data)
        let $ = cheerio.load(html);
        $('b').html() ?
            CVEs.count = $('b').html() :
            CVEs.count = 0 && (CVEs.data = [])
        if (CVEs.count > 0) {
            for (let i = 1; i <= CVEs.count; i++) {
                CVEs.data.push({
                    cve: $(`body > div > div > div > table > tbody > tr:nth-child(${i}) > td:nth-child(1) > a`).text(),
                    description: cleanString($(`body > div > div > div > table > tbody > tr:nth-child(${i}) > td:nth-child(2)`).text())
                })
            }
        }

        CVEs.count > 0 && results.push({
            target,
            softwareName,
            softwareVersion,
            CVEs
        })


    }
    return results

}

module.exports = fetchCVE
    // const res = fetchCVE([{
    //         target: "something1",
    //         softwareName: "Security Intelligence Update for Microsoft Defender Antivirus KB2267602",
    //         softwareVersion: "some version"
    //     },
    //     {
    //         target: "something2",
    //         softwareName: "Security Intelligence Update for Microsoft Defender Antivirus KB2267602",
    //         softwareVersion: "some version"
    //     }
    // ])